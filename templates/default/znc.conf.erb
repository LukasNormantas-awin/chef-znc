// ZNC Configuration
// See also http://en.znc.in/wiki/Configuration
//
// Automagically generated by Chef for <%= node["fqdn"] %>.
// All local changes will be overwritten.

AnonIPLimit = 10
ConnectDelay = 5
<% (node["znc"]["modules"] || {}).each do |mod,params| -%>
LoadModule   = <%= "#{mod} #{params}".strip  %>
<% end -%>
MaxBufferSize = <%= node["znc"]["max_buffer_size"] %>
ProtectWebSessions = true
SSLCertFile  = /etc/znc/znc.pem
ServerThrottle = 30
Skin = <%= node["znc"]["skin"] %>
StatusPrefix = *
Version = 1.0

<Listener listener0>
  AllowIRC = true
  AllowWeb = true
  IPv4 = true
  IPv6 = false
  Port = <%= node["znc"]["port"] %>
  SSL = true
</Listener>

<% @users.each do |u| -%>
<User <%= u["id"]  %>>
  Admin = <%= u["groups"].include?("admin").to_s %>
  Allow = *
  AltNick = <%= u["znc"]["alt_nick"] %>
  AppendTimestamp = false
  AutoClearChanBuffer = true
  Buffer = 250
  ChanModes = +stn
  DenyLoadMod = false
  DenySetBindHost = true
  Ident = <%= u["id"] %>
  JoinTries = 10
  <% (u["znc"]["modules"] || {}).each do |mod,params| -%>
  LoadModule = <%= "#{mod} #{params}".strip %>
  <% end -%>
  MaxNetworks = 10
  MultiClients = true
  Nick = <%= u["znc"]["nick"] %>
  PrependTimestamp = true
  QuitMsg = Leaving
  RealName = <%= u["name"] %>
  TimestampFormat = [%H:%M:%S]

  <% (u["znc"]["networks"] || {}).each do |name, config| -%>
  <Network <%= name %>>
    FloodBurst = 4
    FloodRate = 1.0
    IRCConnectEnabled = true
    <% (config["modules"] || {}).each do |mod, params| -%>
    LoadModule = <%= "#{mod} #{params}".strip %>
    <% end -%>
    <% (config["servers"] || {}).each do |server, port| -%>
    Server = <%= "#{server} #{port}".strip %>
    <% end -%>

    <% (config["channels"] || {}).each do |channel, options| -%>
    <Chan <%= channel %>>
    </Chan>
    <% end -%>
  </Network>
  <% end -%>

  <Pass password>
    <%
    raw_password = u["znc"]["password_hash"]
    password_parts = raw_password.split("#")
    -%>
    Hash = <%= password_parts[1] %>
    Method = <%= password_parts[0] %>
    Salt = <%= password_parts[2] %>
  </Pass>
</User>
<% end -%>
